{{- if and .Values.alertRules.enabled (not .Values.serviceMonitor.enabled) }}
{{- fail "alertRules.enabled=true requires serviceMonitor.enabled=true" }}
{{- end }}
{{- if and .Values.alertRules.enabled (not (or (hasPrefix "https://" .Values.alertRules.runbookUrlBase) (hasPrefix "http://" .Values.alertRules.runbookUrlBase))) }}
{{- fail "alertRules.runbookUrlBase must start with http:// or https://" }}
{{- end }}
{{- if .Values.alertRules.enabled }}
{{- $runbookBase := trimSuffix "/" .Values.alertRules.runbookUrlBase }}
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: {{ include "bijux-atlas.fullname" . }}-alerts
  labels:
    {{- include "bijux-atlas.labels" . | nindent 4 }}
spec:
  groups:
    - name: bijux-atlas-slo
      rules:
        - alert: BijuxAtlasHigh5xxRate
          expr: |
            (
              sum(rate(bijux_http_requests_total{subsystem="atlas",status=~"5.."}[5m]))
              /
              sum(rate(bijux_http_requests_total{subsystem="atlas"}[5m]))
            ) > 0.005
          for: 10m
          labels:
            severity: page
            subsystem: atlas
            version: "1"
          annotations:
            summary: "High 5xx error rate"
            description: "5xx ratio exceeded 0.5% over 10m."
            runbook: "{{ $runbookBase }}/docs/operations/runbooks/incident-playbook.md"
        - alert: BijuxAtlasP95LatencyRegression
          expr: bijux_http_request_latency_p95_seconds{subsystem="atlas",route="/v1/genes"} > 0.8
          for: 15m
          labels:
            severity: page
            subsystem: atlas
            version: "1"
          annotations:
            summary: "v1/genes p95 latency above SLO"
            description: "p95 latency above 800ms for 15m."
            runbook: "{{ $runbookBase }}/docs/operations/runbooks/incident-playbook.md"
        - alert: BijuxAtlasStoreDownloadFailures
          expr: increase(bijux_store_download_failure_total{subsystem="atlas"}[10m]) > 5
          for: 10m
          labels:
            severity: warn
            subsystem: atlas
            version: "1"
          annotations:
            summary: "Store download failures elevated"
            description: "More than 5 store download failures in 10m."
            runbook: "{{ $runbookBase }}/docs/operations/runbooks/store-outage.md"
        - alert: BijuxAtlasCacheThrash
          expr: |
            rate(bijux_dataset_misses{subsystem="atlas"}[10m])
            >
            3 * rate(bijux_dataset_hits{subsystem="atlas"}[10m])
          for: 15m
          labels:
            severity: warn
            subsystem: atlas
            version: "1"
          annotations:
            summary: "Cache thrash detected"
            description: "Dataset miss rate is significantly higher than hit rate."
            runbook: "{{ $runbookBase }}/docs/operations/runbooks/store-outage.md"
{{- end }}
