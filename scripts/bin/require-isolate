#!/usr/bin/env sh
# Purpose: assert command execution happens inside isolate runtime policy.
# Inputs: ISO_* environment variables.
# Outputs: validation error or success status for gate scripts.
set -eu

required_vars="ISO_TAG ISO_RUN_ID ISO_ROOT CARGO_TARGET_DIR CARGO_HOME TMPDIR TMP TEMP"

print_explain() {
  cat <<'TXT'
isolate-required:
- Commands that build/test/lint Rust must run inside an isolate.
- Required env vars: ISO_TAG ISO_RUN_ID ISO_ROOT CARGO_TARGET_DIR CARGO_HOME TMPDIR TMP TEMP.
- Writable paths must be inside ISO_ROOT.
TXT
}

if [ "${1:-}" = "--explain" ]; then
  print_explain
  exit 0
fi

fail() {
  echo "isolate-required: $1" >&2
  exit 1
}

for var in $required_vars; do
  eval "value=\${$var:-}"
  [ -n "$value" ] || fail "missing env var: $var"
done

case "$ISO_ROOT" in
  artifacts/isolates/*) ;;
  */artifacts/isolates/*) ;;
  *) fail "ISO_ROOT must be under artifacts/isolates: $ISO_ROOT" ;;
esac

abs_path() {
  python3 - "$1" <<'PY'
import os
import sys
print(os.path.abspath(sys.argv[1]))
PY
}

iso_root_abs="$(abs_path "$ISO_ROOT")"

for path in "$CARGO_TARGET_DIR" "$CARGO_HOME" "$TMPDIR" "$TMP" "$TEMP"; do
  path_abs="$(abs_path "$path")"
  case "$path" in
    "$ISO_ROOT"/*) continue ;;
  esac
  case "$path_abs" in
    "$iso_root_abs"/*) ;;
    *) fail "path not inside ISO_ROOT: $path" ;;
  esac
done

echo "isolate-required: OK"
