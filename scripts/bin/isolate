#!/usr/bin/env sh
# Purpose: run commands inside deterministic isolated runtime directories.
# Inputs: command-line args plus optional ISO_* env vars.
# Outputs: process execution under artifacts/isolate/<tag> with stable env.
set -eu

SCRIPT_DIR=$(CDPATH= cd -- "$(dirname -- "$0")" && pwd)
ROOT_DIR=$(CDPATH= cd -- "$SCRIPT_DIR/.." && pwd)
ROOT_DIR=$(CDPATH= cd -- "$ROOT_DIR/.." && pwd)
GIT_SHORT_SHA=$(git -C "$ROOT_DIR" rev-parse --short HEAD 2>/dev/null || echo nogit)

print_usage() {
  cat >&2 <<'USAGE'
usage: scripts/bin/isolate [options] <command> [args...]

options:
  --print-root
  --print-env
  --print-tag
  --tag <name>
  --require-clean
  --reuse
USAGE
}

require_clean=0
reuse=0
print_root=0
print_env=0
print_tag=0
explicit_tag=""

while [ "$#" -gt 0 ]; do
  case "$1" in
    --print-root) print_root=1; shift ;;
    --print-env) print_env=1; shift ;;
    --print-tag) print_tag=1; shift ;;
    --tag)
      [ "$#" -ge 2 ] || { echo "isolate: --tag requires value" >&2; exit 2; }
      explicit_tag="$2"; shift 2 ;;
    --require-clean) require_clean=1; shift ;;
    --reuse) reuse=1; shift ;;
    --help|-h) print_usage; exit 0 ;;
    --*) echo "unknown option: $1" >&2; print_usage; exit 2 ;;
    *) break ;;
  esac
done

if [ -n "$explicit_tag" ]; then
  ISO_TAG="$explicit_tag"
elif [ -z "${ISO_TAG:-}" ]; then
  ISO_TAG="$(date -u +%Y%m%dT%H%M%SZ)-${GIT_SHORT_SHA}-$$"
fi

if [ -z "${ISO_ROOT:-}" ]; then
  ISO_ROOT="$ROOT_DIR/artifacts/isolate/$ISO_TAG"
fi

ISO_RUN_ID="${ISO_RUN_ID:-$ISO_TAG}"

if [ "$print_root" -eq 1 ]; then
  echo "$ISO_ROOT"
  exit 0
fi

if [ "$print_tag" -eq 1 ]; then
  echo "$ISO_TAG"
  exit 0
fi

if [ "$print_env" -eq 1 ]; then
  echo "ISO_TAG=$ISO_TAG"
  echo "ISO_RUN_ID=$ISO_RUN_ID"
  echo "ISO_ROOT=$ISO_ROOT"
  echo "CARGO_TARGET_DIR=$ISO_ROOT/target"
  echo "CARGO_HOME=$ISO_ROOT/cargo-home"
  echo "TMPDIR=$ISO_ROOT/tmp"
  echo "TMP=$ISO_ROOT/tmp"
  echo "TEMP=$ISO_ROOT/tmp"
  echo "TZ=UTC"
  echo "LC_ALL=C"
  exit 0
fi

if [ "$#" -eq 0 ]; then
  print_usage
  exit 2
fi

if [ "$require_clean" -eq 1 ] && [ "$reuse" -ne 1 ] && [ -e "$ISO_ROOT" ]; then
  echo "isolate: ISO_ROOT already exists: $ISO_ROOT" >&2
  exit 1
fi

mkdir -p "$ISO_ROOT/target" "$ISO_ROOT/cargo-home" "$ISO_ROOT/tmp"

export ISO_TAG
export ISO_RUN_ID
export ISO_ROOT
export CARGO_TARGET_DIR="$ISO_ROOT/target"
export CARGO_HOME="$ISO_ROOT/cargo-home"
export TMPDIR="$ISO_ROOT/tmp"
export TMP="$ISO_ROOT/tmp"
export TEMP="$ISO_ROOT/tmp"
export TZ="UTC"
export LC_ALL="C"

exec "$@"
