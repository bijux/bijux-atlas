name: compatibility-matrix

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  pull-requests: write

jobs:
  update-matrix:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      ISO_ROOT: artifacts/isolates/compatibility-matrix
      TMPDIR: artifacts/isolates/compatibility-matrix/tmp
      TMP: artifacts/isolates/compatibility-matrix/tmp
      TEMP: artifacts/isolates/compatibility-matrix/tmp
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          ref: main
      - run: cargo run -q -p bijux-dev-atlas -- docs validate --format json
      - name: Create compatibility matrix PR
        uses: peter-evans/create-pull-request@c5a7806660adbe173f04e3e038b0ccdcd758773c
        with:
          commit-message: "docs(compatibility): refresh umbrella-atlas matrix for ${GITHUB_REF_NAME}"
          title: "docs: refresh compatibility matrix for ${GITHUB_REF_NAME}"
          body: "Automated compatibility matrix update for release ${GITHUB_REF_NAME}."
          branch: "automation/compat-matrix-${{ github.ref_name }}"
          delete-branch: true
