name: ci

on:
  push:
    branches: [main]
  pull_request:

permissions:
  contents: read

jobs:
  ci:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.84.1
          components: rustfmt, clippy
      - name: Run canonical CI entrypoint
        run: make ci
      - name: Generate public surface snapshot
        if: always()
        run: |
          mkdir -p artifacts/reports/atlasctl
          ./bin/atlasctl --format json make list > artifacts/reports/atlasctl/public-surface.snapshot.json
          ./bin/atlasctl --format json list suites > artifacts/reports/atlasctl/suites.snapshot.json
          ./bin/atlasctl --format json check list > artifacts/reports/atlasctl/checks.snapshot.json
      - name: Generate bypass report
        if: always()
        run: |
          ./bin/atlasctl policies bypass report --out artifacts/reports/atlasctl/policies-bypass-report.json --report json > artifacts/reports/atlasctl/policies-bypass-report.status.json
          ./bin/atlasctl policies bypass inventory --report json > artifacts/reports/atlasctl/policies-bypass-inventory.json
      - name: Bypass inventory trend snapshot
        if: always()
        run: |
          python3 - <<'PY'
          import json
          from pathlib import Path
          root = Path(".")
          inv = json.loads((root / "artifacts/reports/atlasctl/policies-bypass-inventory.json").read_text())
          baseline = json.loads((root / "configs/policy/bypass-count-baseline.json").read_text())
          current = int(inv.get("entry_count", 0))
          max_entries = int(baseline.get("max_entries", 0))
          payload = {
            "schema_version": 1,
            "kind": "bypass-inventory-trend",
            "comparison": "baseline",
            "current_entry_count": current,
            "baseline_max_entries": max_entries,
            "delta_vs_baseline": current - max_entries,
            "status": "ok" if current <= max_entries else "regressed",
            "source_report": "artifacts/reports/atlasctl/policies-bypass-inventory.json",
            "baseline_file": "configs/policy/bypass-count-baseline.json"
          }
          out = root / "artifacts/reports/atlasctl/policies-bypass-trend.json"
          out.parent.mkdir(parents=True, exist_ok=True)
          out.write_text(json.dumps(payload, indent=2, sort_keys=True) + "\\n", encoding="utf-8")
          PY
      - name: Migration progress gate
        run: |
          ./bin/atlasctl internal migration-progress --json > artifacts/reports/atlasctl/migration-progress.ci.json
          ./bin/atlasctl check run --id checks_repo_migration_progress_regression --json > artifacts/reports/atlasctl/migration-progress.gate.json
      - name: ops/run migration gates
        run: |
          ./bin/atlasctl --format json check run --id checks_ops_scripts_count_nonincreasing > artifacts/reports/atlasctl/ops-run-count-trend.gate.json
          ./bin/atlasctl --format json check run --id checks_ops_run_only_allowlisted_scripts > artifacts/reports/atlasctl/ops-run-allowlist.gate.json
          ./bin/atlasctl --format json check run --id checks_ops_run_temp_script_approvals > artifacts/reports/atlasctl/ops-run-approvals.gate.json
      - name: Generate CI job summary
        if: always()
        run: |
          ./bin/atlasctl reporting ci-summary --latest > artifacts/evidence/ci/ci-summary.json
          ./bin/atlasctl reporting pr-summary --latest > artifacts/evidence/ci/pr-summary.md || true
          cat artifacts/evidence/ci/ci-summary.json >> "$GITHUB_STEP_SUMMARY"
          cat artifacts/evidence/ci/pr-summary.md >> "$GITHUB_STEP_SUMMARY" || true
      - name: Upload CI artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-artifacts
          path: |
            artifacts/**
            ops/_generated/**
      - name: Upload bypass report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bypass-report
          path: |
            artifacts/reports/atlasctl/policies-bypass-report.json
            artifacts/reports/atlasctl/policies-bypass-report.status.json
            artifacts/reports/atlasctl/policies-bypass-inventory.json
            artifacts/reports/atlasctl/policies-bypass-trend.json
      - name: Upload public surface snapshot
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: public-surface-snapshot
          path: |
            artifacts/reports/atlasctl/public-surface.snapshot.json
            artifacts/reports/atlasctl/suites.snapshot.json
            artifacts/reports/atlasctl/checks.snapshot.json

  control-plane-conformance:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Control plane conformance checks
        run: |
          ./bin/atlasctl check run make
          ./bin/atlasctl check run contracts
          ./bin/atlasctl check run docs
      - name: Registry/docs/help/bypass/adjective gates
        run: |
          ./bin/atlasctl --format json check run --id checks_docs_registry_indexes > /tmp/check-docs-registry-indexes.json
          ./bin/atlasctl --format json check run --id checks_docs_ci_lane_mapping > /tmp/check-docs-ci-lane-mapping.json
          ./bin/atlasctl --format json check run --id checks_repo_commands_surface_stability > /tmp/check-help-goldens.json
          ./bin/atlasctl --format json check run --id checks_checks_registry_integrity > /tmp/check-registry-integrity.json
          ./bin/atlasctl --format json check run --id checks_policies_bypass_count_nonincreasing > /tmp/check-bypass-count.json
          ./bin/atlasctl --format json check run --id checks_policies_bypass_count_nonincreasing_hard > /tmp/check-bypass-count-hard.json
          ./bin/atlasctl --format json check run --id checks_policies_adjectives_repo_clean > /tmp/check-adjectives.json
      - name: Optional hard bypass gate
        if: env.ATLASCTL_BYPASS_HARD_FAIL == '1'
        run: |
          ./bin/atlasctl --format json check run --id checks_policies_bypass_hard_gate > /tmp/check-bypass-hard-gate.json

  commands-inventory:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Export command inventory
        run: |
          mkdir -p artifacts/reports/atlasctl
          ./bin/atlasctl --format json list commands > artifacts/reports/atlasctl/commands.snapshot.json
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: commands-inventory
          path: artifacts/reports/atlasctl/commands.snapshot.json

  checks-inventory:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Export checks inventory
        run: |
          mkdir -p artifacts/reports/atlasctl
          ./bin/atlasctl --format json list checks > artifacts/reports/atlasctl/checks.inventory.snapshot.json
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: checks-inventory
          path: artifacts/reports/atlasctl/checks.inventory.snapshot.json

  bypass-report-artifact:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Export bypass report
        run: |
          mkdir -p artifacts/reports/atlasctl
          ./bin/atlasctl report bypass --json --out artifacts/reports/atlasctl/policies-bypass-report.json
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bypass-report-standalone
          path: artifacts/reports/atlasctl/policies-bypass-report.json

  suite-product:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Product validate (fast)
        run: |
          mkdir -p artifacts/reports/atlasctl
          ./bin/atlasctl product validate > artifacts/reports/atlasctl/product-validate.txt
      - name: Suite product fast subset (PR)
        run: |
          mkdir -p artifacts/reports/atlasctl
          ./bin/atlasctl suite run product --only fast --report json > artifacts/reports/atlasctl/suite-product.fast.json

  suite-ops-fast:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Suite ops fast subset
        run: |
          mkdir -p artifacts/reports/atlasctl
          ./bin/atlasctl suite run ops --only fast --report json > artifacts/reports/atlasctl/suite-ops-fast.json
