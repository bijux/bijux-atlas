name: ci

on:
  push:
    branches: [main]
  pull_request:

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  ISO_TAG: github-ci
  ISO_RUN_ID: github-ci
  ISO_ROOT: artifacts/isolates/github-ci
  CARGO_TARGET_DIR: artifacts/isolates/github-ci/target
  CARGO_HOME: artifacts/isolates/github-ci/cargo-home
  TMPDIR: artifacts/isolates/github-ci/tmp
  TMP: artifacts/isolates/github-ci/tmp
  TEMP: artifacts/isolates/github-ci/tmp

jobs:
  workflows-make-only:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: make ci-workflows-make-only

  layout-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: make ci-root-layout

  script-entrypoints:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: make ci-script-entrypoints

  fmt:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.84.1
          components: rustfmt
      - run: make ci-fmt

  clippy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.84.1
          components: clippy
      - run: make ci-clippy

  test-nextest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.84.1
      - run: make ci-test-nextest

  deny:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.84.1
      - run: make ci-deny

  audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.84.1
      - run: make ci-audit

  license-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.84.1
      - run: make ci-license-check

  policy-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: make ci-policy-lint

  policy-schema-drift:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: make ci-policy-schema-drift

  config-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: make ci-config-check

  ssot-drift:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: make ci-ssot-drift

  crate-structure:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: make ci-crate-structure

  crate-docs-contract:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: make ci-crate-docs-contract

  cli-command-surface:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.84.1
      - run: make ci-cli-command-surface

  release-binaries:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.84.1
      - run: make ci-release-binaries

  docs-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: errata-ai/vale-action@v2.1.1
        with:
          files: docs
      - run: make ci-docs-build
      - uses: actions/upload-artifact@v4
        with:
          name: docs-site
          path: artifacts/docs/site

  latency-regression:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.84.1
      - run: make ci-latency-regression

  store-conformance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.84.1
      - run: make ci-store-conformance

  openapi-drift:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: make ci-openapi-drift

  query-plan-gate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.84.1
      - run: make ci-query-plan-gate

  compatibility-matrix-validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: make ci-compatibility-matrix-validate

  runtime-security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: fs
          scan-ref: .
          format: table
          ignore-unfixed: true
          severity: CRITICAL,HIGH
          exit-code: "1"
      - uses: docker/setup-buildx-action@v3
      - run: make ci-runtime-security-scan-image
      - uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: bijux-atlas:local
          format: table
          ignore-unfixed: true
          severity: CRITICAL,HIGH
          exit-code: "1"

  coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.84.1
      - run: make ci-coverage
