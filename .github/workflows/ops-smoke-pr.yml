name: ops-smoke-pr

on:
  pull_request:
    paths:
      - 'ops/**'
      - 'makefiles/**'
      - '.github/workflows/ops-smoke-pr.yml'
      - '.github/workflows/ops-full-nightly.yml'
  workflow_dispatch: {}

concurrency:
  group: kind-ops-smoke-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ops-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    continue-on-error: true
    env:
      ATLAS_RUN_ID: pr-smoke-${{ github.run_id }}
      ATLAS_E2E_CLUSTER_NAME: bijux-atlas-ops-smoke-pr
      ATLAS_E2E_NAMESPACE: atlas-e2e-ops-smoke-pr
      ATLAS_E2E_RELEASE_NAME: atlas-e2e-ops-smoke-pr
      ISO_TAG: ops-smoke-pr
      ISO_RUN_ID: ops-smoke-pr
      ISO_ROOT: artifacts/isolates/ops-smoke-pr
      CARGO_TARGET_DIR: artifacts/isolates/ops-smoke-pr/target
      CARGO_HOME: artifacts/isolates/ops-smoke-pr/cargo-home
      TMPDIR: artifacts/isolates/ops-smoke-pr/tmp
      TMP: artifacts/isolates/ops-smoke-pr/tmp
      TEMP: artifacts/isolates/ops-smoke-pr/tmp
    steps:
      - uses: actions/checkout@v4

      - uses: actions/cache@v4
        with:
          path: ~/.cache/kind
          key: kind-cache-${{ runner.os }}-v0.31.0

      - uses: helm/kind-action@v1.10.0
        with:
          version: v0.31.0
          cluster_name: bijux-atlas-ops-smoke-pr
          config: ops/stack/kind/cluster.yaml

      - uses: azure/setup-helm@v4
      - uses: azure/setup-kubectl@v4
      - uses: grafana/setup-k6-action@v1

      - name: Install helper tools
        run: |
          sudo apt-get update
          sudo apt-get install -y curl netcat-openbsd shellcheck

      - name: Pinned tool checks
        run: make ops-pins-check

      - name: Run ops smoke lane
        run: make ops-check

      - name: Upload ops artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ops-smoke-pr-artifacts
          path: |
            artifacts/ops/**
            artifacts/observability/**

      - name: Tear down cluster
        if: always()
        run: make ops-down
