name: perf-nightly

on:
  schedule:
    - cron: '20 3 * * *'
  workflow_dispatch: {}

jobs:
  nightly-perf:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    env:
      ISO_ROOT: artifacts/isolates/perf-nightly
      CARGO_TARGET_DIR: artifacts/isolates/perf-nightly/target
      CARGO_HOME: artifacts/isolates/perf-nightly/cargo-home
      TMPDIR: artifacts/isolates/perf-nightly/tmp
      TMP: artifacts/isolates/perf-nightly/tmp
      TEMP: artifacts/isolates/perf-nightly/tmp
      SOAK_DURATION: 30m
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Ensure directories
        run: mkdir -p "$ISO_ROOT" "$TMPDIR" artifacts/perf

      - name: Run nightly perf harness
        run: ./scripts/perf/run_nightly_perf.sh

      - name: Run e2e perf scoring suite
        run: ./scripts/perf/run_e2e_perf.sh

      - name: Upload perf artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: perf-nightly-artifacts
          path: |
            artifacts/perf/**
            artifacts/ops/e2e/k6/**

      - name: Prepare regression issue content
        if: failure() && hashFiles('artifacts/perf/regression.txt') != ''
        run: |
          {
            echo "# Nightly Perf Regression"
            echo
            echo "Commit: $GITHUB_SHA"
            echo
            echo "## Violations"
            echo
            cat artifacts/perf/regression.txt
            echo
            echo "## Report"
            echo
            if [ -f artifacts/perf/report.md ]; then
              cat artifacts/perf/report.md
            fi
          } > artifacts/perf/perf-regression-issue.md

      - name: Open regression issue
        if: failure() && hashFiles('artifacts/perf/perf-regression-issue.md') != ''
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "perf-nightly regression: ${{ github.run_id }}"
          content-filepath: artifacts/perf/perf-regression-issue.md
          labels: |
            performance
            regression
            nightly
