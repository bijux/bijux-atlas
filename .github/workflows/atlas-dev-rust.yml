name: atlas-dev-rust

on:
  pull_request:
    paths:
      - 'Cargo.toml'
      - 'Cargo.lock'
      - 'crates/bijux-dev-atlas/**'
      - 'crates/bijux-dev-atlas-core/**'
      - 'crates/bijux-dev-atlas-model/**'
      - 'crates/bijux-dev-atlas-adapters/**'
      - 'crates/bijux-atlas-cli/**'
  push:
    branches: [main]
    paths:
      - 'Cargo.toml'
      - 'Cargo.lock'
      - 'crates/bijux-dev-atlas/**'
      - 'crates/bijux-dev-atlas-core/**'
      - 'crates/bijux-dev-atlas-model/**'
      - 'crates/bijux-dev-atlas-adapters/**'
      - 'crates/bijux-atlas-cli/**'

jobs:
  atlas-dev:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Build atlas dev crates
        run: |
          cargo build -p bijux-dev-atlas-model -p bijux-dev-atlas-adapters -p bijux-dev-atlas-core -p bijux-dev-atlas -p bijux-atlas-cli
      - name: Test atlas dev crates
        run: |
          cargo test -p bijux-dev-atlas-model -p bijux-dev-atlas-adapters -p bijux-dev-atlas-core -p bijux-dev-atlas
      - name: Enforce atlas runtime command surface boundaries
        run: |
          ! rg -n "DevAtlas\\s*\\{" crates/bijux-atlas-cli/src
          ! rg -n "run_dev_atlas\\(" crates/bijux-atlas-cli/src
      - name: Verify atlas runtime command snapshot
        run: |
          cargo test -p bijux-atlas-cli --test lib_contracts
      - name: Smoke help and version
        run: |
          cargo run -p bijux-atlas-cli -- --help >/dev/null
          cargo run -p bijux-atlas-cli -- --version >/dev/null
          cargo run -p bijux-dev-atlas -- --help >/dev/null
          cargo run -p bijux-dev-atlas -- --version >/dev/null
      - name: Verify canonical governance entrypoint
        run: |
          make dev-doctor >/dev/null
          make dev-check-ci >/dev/null
          cargo run -p bijux-dev-atlas -- doctor --format json >/dev/null
          cargo run -p bijux-dev-atlas -- check doctor --format json >/dev/null
          cargo run -p bijux-dev-atlas -- check run --suite ci_fast --format json >/dev/null
      - name: Verify deterministic dev atlas JSON in CI
        run: |
          cargo run -p bijux-dev-atlas -- doctor --format json > /tmp/dev-atlas-doctor.json
          cargo run -p bijux-dev-atlas -- check run --suite ci_fast --format json > /tmp/dev-atlas-ci-fast.json
          ! rg -n "\"(hostname|host|timestamp|created_at)\"" /tmp/dev-atlas-doctor.json /tmp/dev-atlas-ci-fast.json
      - name: Verify ops doctor and validate entrypoints
        run: |
          cargo run -p bijux-dev-atlas -- ops doctor --format json >/dev/null
          cargo run -p bijux-dev-atlas -- ops validate --format json >/dev/null
      - name: Verify ops pins and deterministic kind render check entrypoints
        run: |
          cargo run -p bijux-dev-atlas -- ops pins check --format json >/dev/null
          cargo run -p bijux-dev-atlas -- ops render --target kind --check --format json >/dev/null
      - name: Verify docs doctor entrypoint (no subprocess)
        run: |
          cargo run -p bijux-dev-atlas -- docs doctor --format json >/dev/null
      - name: Enforce governance migration guards
        run: |
          ! rg -n "atlasctl" makefiles/ops.mk makefiles/dev.mk makefiles/ci.mk makefiles/CONTRACT.md ops/CONTRACT.md
          ! rg -n "scripts/areas" makefiles/ops.mk makefiles/dev.mk makefiles/ci.mk .github/workflows/atlas-dev-rust.yml
          ! rg -n "bash ops/|ops/_lib" makefiles/ops.mk .github/workflows/atlas-dev-rust.yml
      - name: Verify ops make wrappers in CI mode
        env:
          BIJUX: bijux
          BIJUX_DEV_ATLAS: cargo run -p bijux-dev-atlas --
        run: |
          make dev-doctor
          make dev-check-ci
          make ops-doctor
          make ops-validate
          make ops-pins-check
          make ops-help >/dev/null
      - name: Verify release binaries are produced
        run: |
          cargo build --release -p bijux-atlas-cli -p bijux-dev-atlas
          test -x artifacts/target/release/bijux-atlas
          test -x artifacts/target/release/bijux-dev-atlas
