name: atlas-dev-rust

on:
  pull_request:
    paths:
      - 'Cargo.toml'
      - 'Cargo.lock'
      - 'crates/bijux-dev-atlas/**'
      - 'crates/bijux-dev-atlas-core/**'
      - 'crates/bijux-dev-atlas-model/**'
      - 'crates/bijux-dev-atlas-adapters/**'
      - 'crates/bijux-atlas-cli/**'
  push:
    branches: [main]
    paths:
      - 'Cargo.toml'
      - 'Cargo.lock'
      - 'crates/bijux-dev-atlas/**'
      - 'crates/bijux-dev-atlas-core/**'
      - 'crates/bijux-dev-atlas-model/**'
      - 'crates/bijux-dev-atlas-adapters/**'
      - 'crates/bijux-atlas-cli/**'

jobs:
  atlas-dev:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Build atlas dev crates
        run: |
          cargo build -p bijux-dev-atlas-model -p bijux-dev-atlas-adapters -p bijux-dev-atlas-core -p bijux-dev-atlas -p bijux-atlas-cli
      - name: Test atlas dev crates
        run: |
          cargo test -p bijux-dev-atlas-model -p bijux-dev-atlas-adapters -p bijux-dev-atlas-core -p bijux-dev-atlas
      - name: Enforce atlas runtime command surface boundaries
        run: |
          ! rg -n "DevAtlas\\s*\\{" crates/bijux-atlas-cli/src
          ! rg -n "run_dev_atlas\\(" crates/bijux-atlas-cli/src
      - name: Verify atlas runtime command snapshot
        run: |
          cargo test -p bijux-atlas-cli --test lib_contracts
      - name: Smoke help and version
        run: |
          cargo run -p bijux-atlas-cli -- --help >/dev/null
          cargo run -p bijux-atlas-cli -- --version >/dev/null
          cargo run -p bijux-dev-atlas -- --help >/dev/null
          cargo run -p bijux-dev-atlas -- --version >/dev/null
      - name: Verify canonical governance entrypoint
        run: |
          cargo run -p bijux-dev-atlas -- doctor --format json >/dev/null
          cargo run -p bijux-dev-atlas -- check doctor --format json >/dev/null
          cargo run -p bijux-dev-atlas -- check run --suite ci_fast --format json >/dev/null
      - name: Verify ops doctor and validate entrypoints
        run: |
          cargo run -p bijux-dev-atlas -- ops doctor --format json >/dev/null
          cargo run -p bijux-dev-atlas -- ops validate --format json >/dev/null
      - name: Enforce ops make/workflow migration guards
        run: |
          ! rg -n "atlasctl" makefiles/ops.mk
          ! rg -n "atlasctl" .github/workflows/atlas-dev-rust.yml
          ! rg -n "scripts/areas|bash ops/|ops/_lib" makefiles/ops.mk .github/workflows/atlas-dev-rust.yml
      - name: Verify ops make wrappers in CI mode
        env:
          BIJUX_DEV_ATLAS: cargo run -p bijux-dev-atlas --
        run: |
          make ops-doctor
          make ops-validate
          make ops-help >/dev/null
      - name: Verify release binaries are produced
        run: |
          cargo build --release -p bijux-atlas-cli -p bijux-dev-atlas
          test -x artifacts/target/release/bijux-atlas
          test -x artifacts/target/release/bijux-dev-atlas
