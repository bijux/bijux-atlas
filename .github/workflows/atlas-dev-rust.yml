name: atlas-dev-rust

on:
  pull_request:
    paths:
      - 'Cargo.toml'
      - 'Cargo.lock'
      - 'crates/bijux-dev-atlas/**'
      - 'crates/bijux-dev-atlas-core/**'
      - 'crates/bijux-dev-atlas-model/**'
      - 'crates/bijux-dev-atlas-adapters/**'
      - 'crates/bijux-atlas-cli/**'
  push:
    branches: [main]
    paths:
      - 'Cargo.toml'
      - 'Cargo.lock'
      - 'crates/bijux-dev-atlas/**'
      - 'crates/bijux-dev-atlas-core/**'
      - 'crates/bijux-dev-atlas-model/**'
      - 'crates/bijux-dev-atlas-adapters/**'
      - 'crates/bijux-atlas-cli/**'

jobs:
  atlas-dev:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.84.1
      - name: Build atlas dev crates
        run: |
          cargo build -p bijux-dev-atlas-model -p bijux-dev-atlas-adapters -p bijux-dev-atlas-core -p bijux-dev-atlas -p bijux-atlas-cli
      - name: Test atlas dev crates
        run: |
          cargo test -p bijux-dev-atlas-model -p bijux-dev-atlas-adapters -p bijux-dev-atlas-core -p bijux-dev-atlas
      - name: Enforce atlas runtime command surface boundaries
        run: |
          ! rg -n "DevAtlas\\s*\\{" crates/bijux-atlas-cli/src
          ! rg -n "run_dev_atlas\\(" crates/bijux-atlas-cli/src
      - name: Verify atlas runtime command snapshot
        run: |
          cargo test -p bijux-atlas-cli --test lib_contracts
      - name: Smoke help and version
        run: |
          cargo run -p bijux-atlas-cli -- --help >/dev/null
          cargo run -p bijux-atlas-cli -- --version >/dev/null
          cargo run -p bijux-dev-atlas -- --help >/dev/null
          cargo run -p bijux-dev-atlas -- --version >/dev/null
      - name: Validate dev atlas plugin metadata JSON
        run: |
          cargo run -p bijux-dev-atlas -- --bijux-plugin-metadata > /tmp/dev-atlas-plugin-metadata.json
          python3 - <<'PY'
          import json
          p = json.load(open("/tmp/dev-atlas-plugin-metadata.json"))
          assert p["schema_version"] == "v1"
          assert p["name"] == "bijux-dev-atlas"
          assert "version" in p and p["version"]
          assert "compatible_umbrella_min" in p and p["compatible_umbrella_min"]
          assert "compatible_umbrella_max_exclusive" in p and p["compatible_umbrella_max_exclusive"]
          PY
      - name: Verify canonical governance entrypoint
        run: |
          make dev-doctor >/dev/null
          make dev-check-ci >/dev/null
          cargo run -p bijux-dev-atlas -- doctor --format json >/dev/null
          cargo run -p bijux-dev-atlas -- check doctor --format json >/dev/null
          cargo run -p bijux-dev-atlas -- check run --suite ci_fast --format json >/dev/null
      - name: Verify deterministic dev atlas JSON in CI
        run: |
          cargo run -p bijux-dev-atlas -- doctor --format json > /tmp/dev-atlas-doctor.json
          cargo run -p bijux-dev-atlas -- check run --suite ci_fast --format json > /tmp/dev-atlas-ci-fast.json
          ! rg -n "\"(hostname|host|timestamp|created_at)\"" /tmp/dev-atlas-doctor.json /tmp/dev-atlas-ci-fast.json
      - name: Verify ops doctor and validate entrypoints
        run: |
          cargo run -p bijux-dev-atlas -- ops doctor --format json >/dev/null
          cargo run -p bijux-dev-atlas -- ops validate --format json >/dev/null
      - name: Verify ops pins and deterministic kind render check entrypoints
        run: |
          cargo run -p bijux-dev-atlas -- ops pins check --format json >/dev/null
          cargo run -p bijux-dev-atlas -- ops render --target kind --check --format json >/dev/null
      - name: Verify docs doctor entrypoint (no subprocess)
        run: |
          make docs-doctor >/dev/null
      - name: Verify docs check entrypoint when mkdocs is available
        run: |
          if command -v mkdocs >/dev/null 2>&1; then
            cargo run -p bijux-dev-atlas -- docs check --allow-subprocess --allow-write --format json >/dev/null
          else
            echo "mkdocs not installed; skipping docs check"
          fi
      - name: Verify configs doctor entrypoint (no subprocess)
        run: |
          CONFIGS_STRICT=--strict make configs-doctor >/dev/null
      - name: Verify configs validate entrypoint
        run: |
          cargo run -p bijux-dev-atlas -- configs validate --strict --format json >/dev/null
      - name: Verify explicit ci-fast suite entrypoint
        run: |
          cargo run -p bijux-dev-atlas -- check run --suite ci_fast --format json >/dev/null
      - name: Enforce governance migration guards
        run: |
          ! rg -n "scripts/areas" makefiles/_ops.mk makefiles/dev.mk makefiles/ci.mk .github/workflows/atlas-dev-rust.yml
          ! rg -n "xtask" makefiles/_ops.mk makefiles/dev.mk makefiles/ci.mk .github/workflows/atlas-dev-rust.yml
          ! rg -n "bash ops/|ops/_lib" makefiles/_ops.mk .github/workflows/atlas-dev-rust.yml
      - name: Verify ops make wrappers in CI mode
        env:
          BIJUX: bijux
          BIJUX_DEV_ATLAS: cargo run -p bijux-dev-atlas --
        run: |
          make dev-doctor
          make dev-ci
          make dev-check-ci
          make ops-doctor
          make ops-validate
          make ops-pins-check
          make docs-doctor
          CONFIGS_STRICT=--strict make configs-doctor
          make ops-help >/dev/null
      - name: Verify release binaries are produced
        run: |
          cargo build --release -p bijux-atlas-cli -p bijux-dev-atlas
          test -x artifacts/target/release/bijux-atlas
          test -x artifacts/target/release/bijux-dev-atlas
      - name: Verify build wrappers produce artifacts
        run: |
          make build
          make dist
          test -x artifacts/bin/bijux-atlas
          test -x artifacts/bin/bijux-dev-atlas
          artifacts/bin/bijux-atlas --version >/dev/null
          artifacts/bin/bijux-dev-atlas --version >/dev/null
          test -f artifacts/bin/manifest.json
          test -f artifacts/dist/sha256sum.txt
      - name: Upload build dist artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dev-atlas-build-dist
          path: |
            artifacts/dist/*
