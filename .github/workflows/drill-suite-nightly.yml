name: drill-suite-nightly

on:
  schedule:
    - cron: '25 2 * * *'
  workflow_dispatch: {}

concurrency:
  group: kind-drill-suite-nightly
  cancel-in-progress: false

jobs:
  drill-suite:
    runs-on: ubuntu-latest
    timeout-minutes: 150
    env:
      ATLAS_RUN_ID: nightly-drill-suite-${{ github.run_id }}
      ATLAS_E2E_CLUSTER_NAME: bijux-atlas-drill-suite-nightly
      ATLAS_E2E_NAMESPACE: atlas-e2e-drill-suite-nightly
      ATLAS_E2E_RELEASE_NAME: atlas-e2e-drill-suite-nightly
    steps:
      - uses: actions/checkout@v4
      - uses: actions/cache@v4
        with:
          path: ~/.cache/kind
          key: kind-cache-${{ runner.os }}-v0.31.0
      - uses: helm/kind-action@v1.10.0
        with:
          version: v0.31.0
          cluster_name: bijux-atlas-drill-suite-nightly
          config: ops/stack/kind/cluster.yaml
      - uses: azure/setup-helm@v4
      - uses: azure/setup-kubectl@v4
      - uses: grafana/setup-k6-action@v1
      - run: make ci-ops-install-prereqs
      - run: make ops-tools-check
      - run: make ops-up
      - run: make ops-deploy
      - run: make ops-warm
      - run: make ops-smoke
      - run: make ops-drill-suite
      - if: always()
        run: make ops-observability-pack-conformance-report
      - if: always()
        uses: actions/upload-artifact@v4
        with:
          name: drill-suite-nightly-artifacts
          path: |
            artifacts/ops/**
            artifacts/observability/**
      - if: always()
        run: make ops-down
