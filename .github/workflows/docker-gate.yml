name: docker-gate

on:
  pull_request:
    paths:
      - "docker/**"
      - "make/docker.mk"
      - "make/root.mk"
      - "crates/bijux-dev-atlas/src/commands/control_plane.rs"
      - "crates/bijux-dev-atlas/tests/dockerfile_contracts.rs"

jobs:
  docker-gate:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      CARGO_HOME: ${{ github.workspace }}/.cache/cargo/home/docker-gate
      CARGO_TARGET_DIR: ${{ github.workspace }}/.cache/cargo/target/docker-gate
      RUSTUP_HOME: ${{ github.workspace }}/.cache/rustup/docker-gate
      RUN_ID: docker-gate-${{ github.run_id }}-${{ github.run_attempt }}
      ISO_ROOT: artifacts/isolates/docker-gate
      TMPDIR: artifacts/isolates/docker-gate/tmp
      TMP: artifacts/isolates/docker-gate/tmp
      TEMP: artifacts/isolates/docker-gate/tmp
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
      - name: Install rust toolchain
        uses: dtolnay/rust-toolchain@631a55b12751854ce901bb631d5902ceb48146f7
      - name: Restore cargo registry cache
        id: cache-registry
        uses: actions/cache/restore@cdf6c1fa76f9f475f3d7449005a359c84ca0f306
        with:
          path: |
            .cache/cargo/home/docker-gate/registry
            .cache/cargo/home/docker-gate/git
          key: cargo-registry-docker-gate-${{ runner.os }}-1.84.1-${{ hashFiles('Cargo.lock') }}
      - name: Restore cargo target cache
        id: cache-target
        uses: actions/cache/restore@cdf6c1fa76f9f475f3d7449005a359c84ca0f306
        with:
          path: .cache/cargo/target/docker-gate
          key: cargo-target-docker-gate-${{ runner.os }}-1.84.1-${{ hashFiles('Cargo.lock') }}
      - name: Run docker static contracts
        shell: bash
        run: |
          set -euo pipefail
          rm -rf "artifacts/${RUN_ID}"
          mkdir -p "artifacts/${RUN_ID}"
          mkdir -p "${ISO_ROOT}" "${TMPDIR}"
          cargo run -q -p bijux-dev-atlas -- contracts self-check --format json > "artifacts/${RUN_ID}/contracts-self-check.json" 2> "artifacts/${RUN_ID}/contracts-self-check.stderr.log"
          cargo run -q -p bijux-dev-atlas -- contracts docker --mode static --format human > "artifacts/${RUN_ID}/docker-contracts.stdout.log" 2> "artifacts/${RUN_ID}/docker-contracts.stderr.log"
      - name: Save cargo registry cache
        if: success()
        uses: actions/cache/save@cdf6c1fa76f9f475f3d7449005a359c84ca0f306
        with:
          path: |
            .cache/cargo/home/docker-gate/registry
            .cache/cargo/home/docker-gate/git
          key: cargo-registry-docker-gate-${{ runner.os }}-1.84.1-${{ hashFiles('Cargo.lock') }}
      - name: Save cargo target cache
        if: success()
        uses: actions/cache/save@cdf6c1fa76f9f475f3d7449005a359c84ca0f306
        with:
          path: .cache/cargo/target/docker-gate
          key: cargo-target-docker-gate-${{ runner.os }}-1.84.1-${{ hashFiles('Cargo.lock') }}
      - uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f
        if: always()
        with:
          name: docker-gate-${{ env.RUN_ID }}
          path: artifacts/${{ env.RUN_ID }}
          retention-days: 5
