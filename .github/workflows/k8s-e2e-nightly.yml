name: k8s-e2e-nightly

on:
  schedule:
    - cron: "30 2 * * *"
  workflow_dispatch: {}

concurrency:
  group: kind-k8s-nightly
  cancel-in-progress: false

jobs:
  kind-helm-suite:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    env:
      ATLAS_E2E_CLUSTER_NAME: bijux-atlas-e2e
      ATLAS_E2E_NAMESPACE: atlas-e2e
      ATLAS_E2E_RELEASE_NAME: atlas-e2e
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Set up Kind
        uses: helm/kind-action@v1.10.0
        with:
          version: v0.31.0
          cluster_name: bijux-atlas-e2e
          config: ops/stack/kind/cluster.yaml

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4

      - name: Install helper tools
        run: |
          sudo apt-get update
          sudo apt-get install -y curl netcat-openbsd

      - name: Set up k6
        uses: grafana/setup-k6-action@v1

      - name: Pinned tool checks
        run: make ops-tools-check

      - name: Bring up e2e dependencies
        run: make ops-up

      - name: Helm install gate
        run: make e2e-k8s-install-gate

      - name: Run full kind+helm suite
        run: make ops-k8s-tests

      - name: Upload K8s suite artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k8s-nightly-artifacts
          path: |
            artifacts/ops/**
            artifacts/ops/k8s/**
            artifacts/ops/k8s-failures/**
            artifacts/ops/k8s-failure-bundle-*.tar.gz
            artifacts/ops/k8s/flake-issue.md

      - name: Open flake issue
        if: always() && hashFiles('artifacts/ops/k8s/flake-issue.md') != ''
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "k8s-e2e flake detected: ${{ github.run_id }}"
          content-filepath: artifacts/ops/k8s/flake-issue.md
          labels: |
            flaky-test
            nightly

      - name: Fetch pinned real datasets
        run: make fetch-real-datasets

      - name: Run real-data regression suite
        run: make e2e-realdata

      - name: Tear down cluster
        if: always()
        run: make ops-down
