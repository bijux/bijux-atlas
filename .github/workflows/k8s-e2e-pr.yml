name: k8s-e2e-pr

on:
  pull_request:
    paths:
      - 'ops/**'
      - 'makefiles/**'
      - '.github/workflows/k8s-e2e-pr.yml'
      - '.github/workflows/k8s-e2e-nightly.yml'

concurrency:
  group: kind-k8s-pr-${{ github.ref }}
  cancel-in-progress: true

jobs:
  k8s-pr-subset:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      CI: "true"
      ATLAS_RUN_ID: pr-${{ github.run_id }}
      ATLAS_E2E_CLUSTER_NAME: bijux-atlas-e2e-pr
      ATLAS_E2E_NAMESPACE: atlas-e2e-pr
      ATLAS_E2E_RELEASE_NAME: atlas-e2e-pr
    steps:
      - uses: actions/checkout@v4

      - name: Set up Kind
        uses: helm/kind-action@v1.10.0
        with:
          version: v0.31.0
          cluster_name: bijux-atlas-e2e-pr
          config: ops/stack/kind/cluster.yaml

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4

      - name: Install helper tools
        run: |
          sudo apt-get update
          sudo apt-get install -y curl netcat-openbsd shellcheck

      - name: Set up k6
        uses: grafana/setup-k6-action@v1

      - name: Pinned tool checks
        run: make ops-tools-check

      - name: Boundary lint (ops/e2e layering)
        run: make policies/boundaries-check

      - name: Bring up e2e dependencies
        run: make ops-up

      - name: Stack smoke gate
        run: make ops-stack-smoke

      - name: Run PR subset (install + values + smoke)
        run: |
          make ops-k8s-tests ATLAS_E2E_TEST=test_values_contract.sh
          make ops-k8s-tests ATLAS_E2E_TEST=test_install.sh
          make ops-k8s-tests ATLAS_E2E_TEST=test_readiness_semantics.sh

      - name: Upload K8s test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k8s-pr-artifacts
          path: |
            artifacts/ops/**
            artifacts/ops/k8s/**
            artifacts/ops/k8s-failures/**
            artifacts/ops/k8s-failure-bundle-*.tar.gz

      - name: Tear down cluster
        if: always()
        run: make ops-down
